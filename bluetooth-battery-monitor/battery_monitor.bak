"""
Bluetooth Headset Battery Indicator
====================================
Check battery percentage of Bluetooth devices connected to Windows PC.

Supports multiple methods:
1. Windows Bluetooth API (via bleak)
2. PowerShell integration
3. WMI queries
4. System tray icon with real-time monitoring

Requirements:
    pip install bleak wmi psutil pystray pillow plyer

Author: Python Projects Collection
"""

import asyncio
import subprocess
import sys
import threading
from datetime import datetime
from typing import List, Optional

# Optional libraries
try:
    from bleak import BleakScanner, BleakClient
    BLEAK_AVAILABLE = True
except ImportError:
    BLEAK_AVAILABLE = False
    print("‚ö†Ô∏è  'bleak' not installed. Install with: pip install bleak")

try:
    import wmi
    WMI_AVAILABLE = True
except ImportError:
    WMI_AVAILABLE = False
    print("‚ö†Ô∏è  'wmi' not installed. Install with: pip install wmi")

try:
    import pystray
    from PIL import Image, ImageDraw, ImageFont
    TRAY_AVAILABLE = True
except ImportError:
    TRAY_AVAILABLE = False
    print("‚ö†Ô∏è  'pystray' or 'pillow' not installed. Install with: pip install pystray pillow")

try:
    from plyer import notification
    NOTIFICATION_AVAILABLE = True
except ImportError:
    NOTIFICATION_AVAILABLE = False
    print("‚ö†Ô∏è  'plyer' not installed. Install with: pip install plyer")


class BluetoothBatteryChecker:
    """Check battery levels of Bluetooth devices"""

    def __init__(self):
        self.devices: List[dict] = []
        self.current_device: Optional[str] = None
        self.last_battery_level: Optional[int] = None
        self.monitoring: bool = False
        self.tray_icon = None

    # ---------- Helpers ----------
    def get_battery_color(self, battery_level: Optional[int]) -> str:
        if battery_level is None:
            return "‚ö™"  # Unknown
        if battery_level >= 70:
            return "üü¢"  # Green - High
        if battery_level >= 20:
            return "üü°"  # Yellow - Medium
        return "üî¥"      # Red - Low

    def create_tray_icon(self, battery_level: Optional[int]):
        if not TRAY_AVAILABLE:
            return None

        img = Image.new("RGB", (64, 64), color="white")
        draw = ImageDraw.Draw(img)

        if battery_level is None:
            color = (128, 128, 128)
        elif battery_level >= 70:
            color = (0, 200, 0)
        elif battery_level >= 20:
            color = (240, 200, 0)
        else:
            color = (220, 0, 0)

        draw.rectangle([10, 20, 54, 50], fill=color, outline=(0, 0, 0), width=2)
        draw.rectangle([54, 30, 58, 40], fill=color, outline=(0, 0, 0), width=2)

        if battery_level is not None:
            try:
                font = ImageFont.truetype("arial.ttf", 16)
            except Exception:
                font = ImageFont.load_default()
            text = f"{battery_level}%"
            bbox = draw.textbbox((0, 0), text, font=font)
            tw = bbox[2] - bbox[0]
            th = bbox[3] - bbox[1]
            draw.text(((64 - tw) // 2, (64 - th) // 2), text, fill=(0, 0, 0), font=font)

        return img

    def show_notification(self, title: str, message: str):
        if not NOTIFICATION_AVAILABLE:
            return
        try:
            notification.notify(title=title, message=message, app_name="Bluetooth Battery Monitor", timeout=5)
        except Exception as exc:  # pragma: no cover - best effort
            print(f"Notification error: {exc}")

    def check_battery_alert(self, battery_level: Optional[int]):
        if battery_level is None:
            return
        if self.last_battery_level is not None:
            if battery_level < 20 <= self.last_battery_level:
                self.show_notification("üî¥ Low Battery", f"Battery is low: {battery_level}%")
            if battery_level >= 70 and (self.last_battery_level < 70):
                self.show_notification("üü¢ Battery Charged", f"Battery is charged: {battery_level}%")
        self.last_battery_level = battery_level

    # ---------- BLE ----------
    async def scan_bluetooth_devices(self) -> List[dict]:
        if not BLEAK_AVAILABLE:
            print("‚ùå Bleak library not available")
            return []
        print("üîç Scanning for Bluetooth devices...")
        devices = await BleakScanner.discover(timeout=10.0)
        self.devices = [
            {
                "name": dev.name or "Unknown",
                "address": dev.address,
                "rssi": dev.rssi,
            }
            for dev in devices
        ]
        for info in self.devices:
            print(f"  üì± Found: {info['name']} ({info['address']})")
        return self.devices

    async def get_battery_level_ble(self, address: str) -> Optional[int]:
        if not BLEAK_AVAILABLE:
            return None
        try:
            print(f"üîå Connecting to {address}...")
            async with BleakClient(address, timeout=15.0) as client:
                if not client.is_connected:
                    print("‚ùå Failed to connect")
                    return None
                try:
                    level = await client.read_gatt_char("00002a19-0000-1000-8000-00805f9b34fb")
                    return int(level[0])
                except Exception as exc:
                    print(f"‚ö†Ô∏è  Battery service not available: {exc}")
                    return None
        except Exception as exc:
            print(f"‚ùå Error connecting: {exc}")
            return None

    # ---------- PowerShell ----------
    def get_battery_powershell(self):
        try:
            ps_command = r"""
            Get-PnpDevice -Class Bluetooth | Where-Object {$_.Status -eq 'OK'} |
            ForEach-Object {
                $device = $_
                $battery = Get-PnpDeviceProperty -InstanceId $device.InstanceId -KeyName '{104EA319-6EE2-4701-BD47-8DDBF425BBE5} 2' -ErrorAction SilentlyContinue
                if ($battery) {
                    [PSCustomObject]@{
                        Name = $device.FriendlyName
                        Status = $device.Status
                        Battery = $battery.Data
                    }
                }
            } | ConvertTo-Json
            """
            result = subprocess.run(["powershell", "-Command", ps_command], capture_output=True, text=True, timeout=10)
            if result.returncode == 0 and result.stdout.strip():
                print("üìä PowerShell Results:")
                print(result.stdout)
                return result.stdout
            print("‚ö†Ô∏è  No battery info available via PowerShell")
        except Exception as exc:
            print(f"‚ùå PowerShell error: {exc}")
        return None

    # ---------- WMI ----------
    def get_battery_wmi(self):
        if not WMI_AVAILABLE:
            print("‚ùå WMI library not available")
            return None
        try:
            print("üîç Checking WMI for Bluetooth devices...")
            c = wmi.WMI()
            devices = c.Win32_PnPEntity(ConfigManagerErrorCode=0)
            bluetooth_devices = [
                {
                    "name": dev.Name,
                    "device_id": dev.DeviceID,
                    "status": dev.Status,
                }
                for dev in devices
                if dev.Name and "bluetooth" in dev.Name.lower()
            ]
            if bluetooth_devices:
                print(f"üì± Found {len(bluetooth_devices)} Bluetooth devices:")
                for dev in bluetooth_devices:
                    print(f"  ‚Ä¢ {dev['name']}")
                return bluetooth_devices
            print("‚ö†Ô∏è  No Bluetooth devices found via WMI")
        except Exception as exc:
            print(f"‚ùå WMI error: {exc}")
        return None

    # ---------- Windows API ----------
    def get_battery_windows_api(self):
        try:
            ps_command = r"""
            $devices = Get-PnpDevice | Where-Object {$_.Class -eq 'Bluetooth' -and $_.Status -eq 'OK'}
            foreach ($device in $devices) {
                Write-Host "Device: $($device.FriendlyName)"
                Write-Host "Status: $($device.Status)"
                Write-Host "---"
            }
            """
            result = subprocess.run(["powershell", "-Command", ps_command], capture_output=True, text=True, timeout=10)
            if result.returncode == 0:
                return result.stdout
        except Exception as exc:
            print(f"‚ùå Windows API error: {exc}")
        return None


# ---------- UI Helpers ----------

    print("\n" + "=" * 60)
    print("üéß BLUETOOTH HEADSET BATTERY CHECKER üîã")
    print("=" * 60)
    print(f"‚è∞ {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")


def print_menu():
    print("\nüìã Select Method:\n")
    print("1. üîç Scan for BLE devices and check battery")
    print("2. üíª Use PowerShell to check battery")
    print("3. üñ•Ô∏è  Use WMI to list Bluetooth devices")
    print("4. ü™ü Use Windows API")
    print("5. üîÑ Try all methods")
    print("6. üéØ Monitor device in system tray")
    print("7. ‚ùå Exit")
    print()


async def monitor_device_background(checker: BluetoothBatteryChecker, device_address: str, device_name: str):
    print(f"\nüîÑ Starting background monitoring for: {device_name}")
    print("üí° Check system tray (near clock) for battery icon")
    print("‚è∏Ô∏è  Press Ctrl+C to stop monitoring\n")

    checker.monitoring = True
    checker.current_device = device_address

    while checker.monitoring:
        try:
            battery = await checker.get_battery_level_ble(device_address)
            if battery is not None:
                color_emoji = checker.get_battery_color(battery)
                print(f"{color_emoji} {device_name}: {battery}% - {datetime.now().strftime('%H:%M:%S')}")
                checker.check_battery_alert(battery)
                if checker.tray_icon:
                    new_icon = checker.create_tray_icon(battery)
                    if new_icon:
                        checker.tray_icon.icon = new_icon
                        checker.tray_icon.title = f"{device_name}: {battery}%"
            else:
                print(f"‚ö†Ô∏è  Could not read battery - {datetime.now().strftime('%H:%M:%S')}")
            await asyncio.sleep(60)
        except Exception as exc:
            print(f"‚ùå Monitoring error: {exc}")
            await asyncio.sleep(60)


def start_tray_icon(checker: BluetoothBatteryChecker, device_name: str, battery_level: Optional[int] = None):
    if not TRAY_AVAILABLE:
        print("‚ö†Ô∏è  System tray not available. Monitoring in console only.")
        return None

    icon_image = checker.create_tray_icon(battery_level)

    def on_quit(icon, _item):
        checker.monitoring = False
        icon.stop()

    def on_show_battery(icon, _item):
        if checker.last_battery_level is not None:
            color_emoji = checker.get_battery_color(checker.last_battery_level)
            checker.show_notification(f"{color_emoji} Battery Status", f"{device_name}\nBattery: {checker.last_battery_level}%")

    menu = pystray.Menu(pystray.MenuItem("Show Battery", on_show_battery), pystray.MenuItem("Quit", on_quit))
    icon = pystray.Icon("bluetooth_battery", icon_image, f"{device_name}: Connecting...", menu)
    checker.tray_icon = icon
    threading.Thread(target=icon.run, daemon=True).start()
    return icon


async def main():
    print_header()

    print("üì¶ Checking dependencies...")
    print(f"  ‚Ä¢ Bleak (BLE): {'‚úÖ Available' if BLEAK_AVAILABLE else '‚ùå Not installed'}")
    print(f"  ‚Ä¢ WMI: {'‚úÖ Available' if WMI_AVAILABLE else '‚ùå Not installed'}")
    print(f"  ‚Ä¢ System Tray: {'‚úÖ Available' if TRAY_AVAILABLE else '‚ùå Not installed'}")
    print(f"  ‚Ä¢ Notifications: {'‚úÖ Available' if NOTIFICATION_AVAILABLE else '‚ùå Not installed'}")
    print()

    if not BLEAK_AVAILABLE and not WMI_AVAILABLE:
        print("‚ö†Ô∏è  No Bluetooth libraries available!")
        print("üì• Install with: pip install bleak wmi")
        print()

    checker = BluetoothBatteryChecker()

    while True:
        print_menu()
        choice = input("üëâ Enter your choice (1-7): ").strip()

        if choice == "1":
            if not BLEAK_AVAILABLE:
                print("‚ùå Bleak not installed. Install with: pip install bleak")
                continue
            print("\n" + "‚îÄ" * 60)
            devices = await checker.scan_bluetooth_devices()
            if devices:
                print(f"\n‚úÖ Found {len(devices)} device(s)")
                print("\nSelect a device to check battery:")
                for i, dev in enumerate(devices, 1):
                    print(f"  {i}. {dev['name']} ({dev['address']})")
                try:
                    dev_choice = int(input("\nüëâ Enter device number: ")) - 1
                    if 0 <= dev_choice < len(devices):
                        device = devices[dev_choice]
                        print(f"\nüîã Checking battery for: {device['name']}")
                        battery = await checker.get_battery_level_ble(device['address'])
                        if battery is not None:
                            color_emoji = checker.get_battery_color(battery)
                            print(f"\n{'‚îÄ' * 40}")
                            print(f"üéß Device: {device['name']}")
                            print(f"{color_emoji} Battery: {battery}%")
                            print(f"{'‚îÄ' * 40}\n")
                        else:
                            print("‚ö†Ô∏è  Could not read battery level")
                            print("üí° Note: Device must support Battery Service")
                    else:
                        print("‚ùå Invalid device number")
                except ValueError:
                    print("‚ùå Invalid input")
            else:
                print("‚ö†Ô∏è  No devices found")

        elif choice == "2":
            print("\n" + "‚îÄ" * 60)
            checker.get_battery_powershell()

        elif choice == "3":
            print("\n" + "‚îÄ" * 60)
            checker.get_battery_wmi()

        elif choice == "4":
            print("\n" + "‚îÄ" * 60)
            result = checker.get_battery_windows_api()
            if result:
                print(result)

        elif choice == "5":
            print("\n" + "=" * 60)
            print("üîÑ TRYING ALL METHODS")
            print("=" * 60)

            print("\n1Ô∏è‚É£  METHOD 1: BLE Scan")
            print("‚îÄ" * 60)
            if BLEAK_AVAILABLE:
                await checker.scan_bluetooth_devices()
            else:
                print("‚ùå Bleak not available")

            print("\n2Ô∏è‚É£  METHOD 2: PowerShell")
            print("‚îÄ" * 60)
            checker.get_battery_powershell()

            print("\n3Ô∏è‚É£  METHOD 3: WMI")
            print("‚îÄ" * 60)
            checker.get_battery_wmi()

            print("\n4Ô∏è‚É£  METHOD 4: Windows API")
            print("‚îÄ" * 60)
            result = checker.get_battery_windows_api()
            if result:
                print(result)

        elif choice == "6":
            if not BLEAK_AVAILABLE:
                print("‚ùå Bleak not installed. Install with: pip install bleak")
                continue
            print("\n" + "‚îÄ" * 60)
            devices = await checker.scan_bluetooth_devices()
            if devices:
                print(f"\n‚úÖ Found {len(devices)} device(s)")
                print("\nSelect a device to monitor:")
                for i, dev in enumerate(devices, 1):
                    print(f"  {i}. {dev['name']} ({dev['address']})")
                try:
                    dev_choice = int(input("\nüëâ Enter device number: ")) - 1
                    if 0 <= dev_choice < len(devices):
                        device = devices[dev_choice]
                        if TRAY_AVAILABLE:
                            start_tray_icon(checker, device['name'])
                        if NOTIFICATION_AVAILABLE:
                            checker.show_notification("üéß Battery Monitor Started", f"Now monitoring: {device['name']}")
                        try:
                            await monitor_device_background(checker, device['address'], device['name'])
                        except KeyboardInterrupt:
                            print("\n\n‚èπÔ∏è  Monitoring stopped")
                            checker.monitoring = False
                            if checker.tray_icon:
                                checker.tray_icon.stop()
                    else:
                        print("‚ùå Invalid device number")
                except ValueError:
                    print("‚ùå Invalid input")
            else:
                print("‚ö†Ô∏è  No devices found")

        elif choice == "7":
            print("\nüëã Goodbye!\n")
            break

        else:
            print("‚ùå Invalid choice. Please select 1-7.")

        input("\n‚è∏Ô∏è  Press Enter to continue...")
        print("\n" * 2)


def install_dependencies():
    print("üì• Installing required dependencies...\n")
    packages = ["bleak", "wmi", "psutil", "pystray", "pillow", "plyer"]
    for package in packages:
        print(f"Installing {package}...")
        subprocess.run([sys.executable, "-m", "pip", "install", package])
    print("\n‚úÖ Installation complete!")
    print("üí° Restart the script to use all features")


if __name__ == "__main__":
    if len(sys.argv) > 1 and sys.argv[1] == "--install":
        install_dependencies()
    else:
        try:
            asyncio.run(main())
        except KeyboardInterrupt:
            print("\n\nüëã Interrupted by user. Goodbye!\n")
        except Exception as exc:
            print(f"\n‚ùå Error: {exc}")
            print("üí° Try running: python battery_monitor.py --install")
                except ValueError:
